name: docs-3rd-person-check
on:
  push:
    tags:
      - v*
    branches:
      - master
      - main
      - release-*
  pull_request:
    branches:
      - master
      - main
      - release-*

# cancel the in-progress workflow when PR is refreshed.
concurrency:
  group: ${{ github.workflow }}-${{ github.event_name == 'pull_request' && github.head_ref || github.sha }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  docs-3rd-person-check:
    name: docs-3rd-person-check
    runs-on: ubuntu-20.04
    steps:
      - name: Dump GitHub context
        env:
          GITHUB_CONTEXT: ${{ toJson(github) }}
        run: echo "$GITHUB_CONTEXT"
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v42
        with:
          # Avoid using single or double quotes for multiline patterns
          files: | 
            Documentation/**.md
            Documentation/**/**.md

      - name: List all changed markdown files with 3rd person
        if: steps.changed-files.outputs.any_changed == 'true'
        env:
          ALL_CHANGED_DOCS: ${{ steps.changed-files.outputs.all_changed_files }}
        run: |
          # Get sha for content compare
          if [[ "${{ github.event_name }}" == "pull_request" ]];then
             diff_start=${{ github.event.pull_request.base.sha }}
             diff_end=${{ github.event.pull_request.head.sha }}
          elif [[ "${{ github.event_name }}" == "push" ]];then 
             diff_start=${{ github.event.before }}
             diff_end=${{ github.event.after }}
          else
             echo "unsupported event type:${{ github.event_name }}"
             exit 1
          fi
          echo -e "changed md files: \n ${ALL_CHANGED_DOCS}"
          echo "diff from ${diff_start} to ${diff_end}"
          error_msg=''
          for file in ${ALL_CHANGED_DOCS}; do
            #filter added contents with keyword ignore case
            content_3rd="$(git diff ${diff_start} ${diff_end} ${file}|tail -n -4|grep '^+'|grep -iw 'you\|they')"
            if [[ "x${content_3rd}" != "x" ]] ; then
              error_msg="${error_files}${file}\n    ${content_3rd}\n"
            fi
          done
          if [[ "x${error_msg}" != "x" ]]; then
             echo -e "In the docs we try not to use 'you' or 'they' ,please check the files below: \n ${error_msg}"
             exit 1
          fi
        
