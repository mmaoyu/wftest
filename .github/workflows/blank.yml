name: docs-3rd-person-check
on:
  push:
    tags:
      - v*
    branches:
      - master
      - main
      - release-*
  pull_request:
    branches:
      - master
      - main
      - release-*

# cancel the in-progress workflow when PR is refreshed.
concurrency:
  group: ${{ github.workflow }}-${{ github.event_name == 'pull_request' && github.head_ref || github.sha }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  docs-3rd-person-check:
    name: docs-3rd-person-check
    runs-on: ubuntu-20.04
    steps:
      - name: Dump GitHub context
        env:
          GITHUB_CONTEXT: ${{ toJson(github) }}
        run: echo "$GITHUB_CONTEXT"
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v42
        with:
          # Avoid using single or double quotes for multiline patterns
          files: | 
            Documentation/**.md
            Documentation/**/**.md

      - name: List all changed files markdown files with 3rd person('you','they')
        if: steps.changed-files.outputs.any_changed == 'true'
        env:
          ALL_CHANGED_DOCS: ${{ steps.changed-files.outputs.all_changed_files }}
        run: |
          echo "ref_name: ${{ github.ref_name }}"
          if [[ "${{ github.event_name }}" == "pull_request" ]];then
             diff_start=${{ github.event.pull_request.base.sha }}
             diff_end=${{ github.event.pull_request.head.sha }}
          elif [[ "${{ github.event_name }}" == "push" ]];then 
             diff_start=${{ github.event.before }}
             diff_end=${{ github.event.after }}
          else
             echo "not supported event type:${{ github.event_name }}"
             exit 1
          fi
          error_files=''
          for file in ${ALL_CHANGED_DOCS}; do
            echo "file name:${file}"
            echo "file content: $(git diff ${diff_start} ${diff_end} ${file})"
            echo "file changed: $(git diff ${diff_start} ${diff_end} ${file}|tail -n -4|grep '^+'|grep -iw 'you\|they')"
            
            if git diff ${diff_start} ${diff_end} ${file}|tail -n -4|grep '^+'|grep -iw 'you\|they' > /dev/null ; then
              error_files="${error_files} ${file}\n"
            fi
          done
          if [[ "x${error_files}" != "x" ]]; then
             echo -e "In the docs we try not to use 'you' or 'they' ,please check the files below: \n ${error_files}"
             exit 1
          fi
        
