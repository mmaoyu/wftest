name: docs-keywords-filter
on:
  push:
    tags:
      - v*
    branches:
      - master
      - main
      - release-*
  pull_request:
    branches:
      - master
      - main
      - release-*

# cancel the in-progress workflow when PR is refreshed.
concurrency:
  group: ${{ github.workflow }}-${{ github.event_name == 'pull_request' && github.head_ref || github.sha }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  docs-keywords-filter:
    name: docs-keywords-filter
    runs-on: ubuntu-20.04
    steps:
      - name: Dump GitHub context
        env:
          GITHUB_CONTEXT: ${{ toJson(github) }}
        run: echo "$GITHUB_CONTEXT"
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Get changed docs
        id: changed-docs
        uses: tj-actions/changed-files@v42
        with:
          # Avoid using single or double quotes for multiline patterns
          files: | 
            Documentation/**.md
            Documentation/**/**.md

      - name: List all changed docs with keywords
        if: steps.changed-docs.outputs.any_changed == 'true'
        env:
          ALL_CHANGED_DOCS: ${{ steps.changed-docs.outputs.all_changed_files }}
          # Keywords regex for grep 
          GREP_KEYWORD_DICS: 'you\|they'
          # Error tips
          TIPS: 'In the docs we try not to use (you,they),please check the file(s) below:'
        run: |
          
          echo -e "Changed files: \n ${ALL_CHANGED_DOCS}"
         
          # Get SHA
          if [[ "${{ github.event_name }}" == "pull_request" ]];then
             base_sha=${{ github.event.pull_request.base.sha }}
             head_sha=${{ github.event.pull_request.head.sha }}
          else
            base_sha=${{ github.event.before }}
            head_sha=${{ github.event.after }}
          fi
          
          echo "Base SHA:${base_sha},head SHA:${head_sha}"
          error_msg=''
          for file in ${ALL_CHANGED_DOCS}; do
            #filter added contents with keyword ignore case
            content_with_keyword="$(git diff ${base_sha} ${head_sha} ${file}|tail -n -4|grep '^+'|grep -iw ${GREP_KEYWORD_DICS})"
            if [[ "x${content_with_keyword}" != "x" ]] ; then
              error_msg="${error_msg}${file}\n${content_with_keyword}\n\n"
            fi
          done
          if [[ "x${error_msg}" != "x" ]]; then
             echo -e "\n${TIPS}\n${error_msg}"
             exit 1
          fi
        
